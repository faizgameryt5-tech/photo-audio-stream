name: Photo + Audio Stream (Auto Reconnect + Restart)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  photo-audio-stream:
    runs-on: ubuntu-latest

    timeout-minutes: 355   # ~5h55m (GitHub limit se thoda kam)

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Verify Files
        run: |
          if [ ! -f "./background.png" ]; then
            echo "background.png missing!" && exit 1
          fi
          if [ ! -f "./audio.mp3" ]; then
            echo "audio.mp3 missing!" && exit 1
          fi
          echo "Files OK"

      - name: Start Stable Stream
        run: |
          STREAM_URL="rtmp://a.rtmp.youtube.com/live2/k4bv-wakv-50ad-uas6-8rtr"

          while true
          do
            echo "Starting stream..."

            ffmpeg \
              -reconnect 1 \
              -reconnect_streamed 1 \
              -reconnect_delay_max 10 \
              -re \
              -loop 1 -i background.png \
              -stream_loop -1 -i audio.mp3 \
              -c:v libx264 \
              -preset veryfast \
              -tune stillimage \
              -pix_fmt yuv420p \
              -g 50 \
              -b:v 2500k \
              -maxrate 2500k \
              -bufsize 5000k \
              -c:a aac \
              -b:a 160k \
              -ar 44100 \
              -f flv \
              -t 05:40:00 \
              "$STREAM_URL"

            echo "Stream crashed or finished. Restarting in 15s..."
            sleep 15
          done
